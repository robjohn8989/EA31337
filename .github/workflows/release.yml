---
name: Release

on:
  push:
    branches:
      - 'v*'
    paths:
      - '.github/workflows/release.y?ml'
      - '**/*.mq?'
    tags:
      - 'v*'
  release:
    types:
      - prereleased
      - published
      - unpublished

jobs:
  Lite:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Compile
        run: docker-compose run lite
        working-directory: docker/compile/lite
      - name: Adjust filename
        run: mv -v *.ex4 "EA31337-Lite-${GITHUB_BRANCH##*/}.ex4"
        env:
          GITHUB_BRANCH: ${{ github.ref }}
      - name: Test 2018.01
        uses: fx31337/mql-tester-action@master
        with:
          TestExpert: EA31337-Lite
          BtMonths: 1
          BtYears: 2018
          RunOnWarning: 'show_logs && parse_results $@ && git diff && exit 0'
          RunOnSuccess: 'git diff'
      - name: Check results
        run: git diff
  Advanced:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Compile
        run: docker-compose run advanced
        working-directory: docker/compile/advanced
      - name: Adjust filename
        run: mv -v *.ex4 "EA31337-Advanced-${GITHUB_BRANCH##*/}.ex4"
        env:
          GITHUB_BRANCH: ${{ github.ref }}
      - name: Test 2018.01
        uses: fx31337/mql-tester-action@master
        with:
          TestExpert: EA31337-Advanced
          BtMonths: 1
          BtYears: 2018
          RunOnWarning: 'show_logs && parse_results $@ && git diff && exit 0'
          RunOnSuccess: 'git diff'
      - name: Check results
        run: git diff
  Rider:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Compile
        run: docker-compose run rider
        working-directory: docker/compile/rider
      - name: Adjust filename
        run: mv -v *.ex4 "EA31337-Rider-${GITHUB_BRANCH##*/}.ex4"
        env:
          GITHUB_BRANCH: ${{ github.ref }}
      - name: Test 2018.01
        uses: fx31337/mql-tester-action@master
        with:
          TestExpert: EA31337-Rider
          BtMonths: 1
          BtYears: 2018
          RunOnWarning: 'show_logs && parse_results $@ && git diff && exit 0'
          RunOnSuccess: 'git diff'
      - name: Check results
        run: git diff
